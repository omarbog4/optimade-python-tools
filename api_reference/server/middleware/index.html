<!DOCTYPE html>
<html class="no-js" lang="en"> <head><meta charset="utf-8"/><meta content="width=device-width,initial-scale=1" name="viewport"/><meta content="Documentation for the OPTIMADE Python tools" name="description"/><link href="https://www.optimade.org/optimade-python-tools/api_reference/server/middleware/" rel="canonical"/><link href="../../../images/favicon.png" rel="shortcut icon"/><meta content="mkdocs-1.1.2, mkdocs-material-5.5.3" name="generator"/><title>middleware - OPTIMADE Python tools</title><link href="../../../assets/stylesheets/main.947af8d5.min.css" rel="stylesheet"/><link href="../../../assets/stylesheets/palette.7f672a1f.min.css" rel="stylesheet"/><meta content="" name="theme-color"/><link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/><link href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&amp;display=fallback" rel="stylesheet"/><style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style><link href="../../../css/reference.css" rel="stylesheet"/></head> <body data-md-color-accent="red" data-md-color-primary="black" data-md-color-scheme="default" dir="ltr"> <input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/> <input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/> <label class="md-overlay" for="__drawer"></label> <div data-md-component="skip"> <a class="md-skip" href="#middleware"> Skip to content </a> </div> <div data-md-component="announce"> </div> <header class="md-header" data-md-component="header"> <nav aria-label="Header" class="md-header-nav md-grid"> <a aria-label="OPTIMADE Python tools" class="md-header-nav__button md-logo" href="https://www.optimade.org/optimade-python-tools/" title="OPTIMADE Python tools"> <img alt="logo" src="../../../images/optimade_logo_180x180.svg"/> </a> <label class="md-header-nav__button md-icon" for="__drawer"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"></path></svg> </label> <div class="md-header-nav__title" data-md-component="header-title"> <div class="md-header-nav__ellipsis"> <span class="md-header-nav__topic md-ellipsis"> OPTIMADE Python tools </span> <span class="md-header-nav__topic md-ellipsis"> middleware </span> </div> </div> <label class="md-header-nav__button md-icon" for="__search"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg> </label> <div class="md-search" data-md-component="search" role="dialog"> <label class="md-search__overlay" for="__search"></label> <div class="md-search__inner" role="search"> <form class="md-search__form" name="search"> <input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" data-md-state="active" name="query" placeholder="Search" spellcheck="false" type="text"/> <label class="md-search__icon md-icon" for="__search"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </label> <button aria-label="Clear" class="md-search__icon md-icon" data-md-component="search-reset" tabindex="-1" type="reset"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg> </button> </form> <div class="md-search__output"> <div class="md-search__scrollwrap" data-md-scrollfix=""> <div class="md-search-result" data-md-component="search-result"> <div class="md-search-result__meta"> Initializing search </div> <ol class="md-search-result__list"></ol> </div> </div> </div> </div> </div> <div class="md-header-nav__source"> <a class="md-source" href="https://github.com/Materials-Consortia/optimade-python-tools" title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg> </div> <div class="md-source__repository"> optimade-python-tools </div> </a> </div> </nav> </header> <div class="md-container" data-md-component="container"> <main class="md-main" data-md-component="main"> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component="navigation"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0"> <label class="md-nav__title" for="__drawer"> <a aria-label="OPTIMADE Python tools" class="md-nav__button md-logo" href="https://www.optimade.org/optimade-python-tools/" title="OPTIMADE Python tools"> <img alt="logo" src="../../../images/optimade_logo_180x180.svg"/> </a> OPTIMADE Python tools </label> <div class="md-nav__source"> <a class="md-source" href="https://github.com/Materials-Consortia/optimade-python-tools" title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg> </div> <div class="md-source__repository"> optimade-python-tools </div> </a> </div> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../.." title="OPTIMADE Python tools"> OPTIMADE Python tools </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../install/" title="Installation"> Installation </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../configuration/" title="Configuration"> Configuration </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../CONTRIBUTING/" title="Contributing"> Contributing </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" id="nav-5" type="checkbox"/> <label class="md-nav__link" for="nav-5"> Use Cases <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="Use Cases" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="nav-5"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> Use Cases </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../use_cases/single_db/" title="A single database"> A single database </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../use_cases/multi_db/" title="Multiple databases"> Multiple databases </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../use_cases/dynamic_db/" title="Dynamic databases"> Dynamic databases </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../CHANGELOG/" title="Changelog"> Changelog </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../all_models/" title="All models"> All models </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input checked="" class="md-nav__toggle md-toggle" data-md-toggle="nav-8" id="nav-8" type="checkbox"/> <label class="md-nav__link" for="nav-8"> API Reference <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="API Reference" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="nav-8"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> API Reference </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-1" id="nav-8-1" type="checkbox"/> <label class="md-nav__link" for="nav-8-1"> adapters <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="adapters" class="md-nav" data-md-level="2"> <label class="md-nav__title" for="nav-8-1"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> adapters </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../adapters/base/" title="base"> base </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../adapters/exceptions/" title="exceptions"> exceptions </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../adapters/logger/" title="logger"> logger </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-1-4" id="nav-8-1-4" type="checkbox"/> <label class="md-nav__link" for="nav-8-1-4"> references <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="references" class="md-nav" data-md-level="3"> <label class="md-nav__title" for="nav-8-1-4"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> references </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../adapters/references/adapter/" title="adapter"> adapter </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-1-5" id="nav-8-1-5" type="checkbox"/> <label class="md-nav__link" for="nav-8-1-5"> structures <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="structures" class="md-nav" data-md-level="3"> <label class="md-nav__title" for="nav-8-1-5"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> structures </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../adapters/structures/adapter/" title="adapter"> adapter </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../adapters/structures/aiida/" title="aiida"> aiida </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../adapters/structures/ase/" title="ase"> ase </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../adapters/structures/cif/" title="cif"> cif </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../adapters/structures/jarvis/" title="jarvis"> jarvis </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../adapters/structures/proteindatabank/" title="proteindatabank"> proteindatabank </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../adapters/structures/pymatgen/" title="pymatgen"> pymatgen </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../adapters/structures/utils/" title="utils"> utils </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-2" id="nav-8-2" type="checkbox"/> <label class="md-nav__link" for="nav-8-2"> filterparser <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="filterparser" class="md-nav" data-md-level="2"> <label class="md-nav__title" for="nav-8-2"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> filterparser </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../filterparser/lark_parser/" title="lark_parser"> lark_parser </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-3" id="nav-8-3" type="checkbox"/> <label class="md-nav__link" for="nav-8-3"> filtertransformers <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="filtertransformers" class="md-nav" data-md-level="2"> <label class="md-nav__title" for="nav-8-3"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> filtertransformers </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../filtertransformers/debug/" title="debug"> debug </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../filtertransformers/django/" title="django"> django </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../filtertransformers/elasticsearch/" title="elasticsearch"> elasticsearch </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../filtertransformers/json/" title="json"> json </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../filtertransformers/mongo/" title="mongo"> mongo </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-4" id="nav-8-4" type="checkbox"/> <label class="md-nav__link" for="nav-8-4"> models <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="models" class="md-nav" data-md-level="2"> <label class="md-nav__title" for="nav-8-4"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> models </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../models/baseinfo/" title="baseinfo"> baseinfo </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../models/entries/" title="entries"> entries </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../models/index_metadb/" title="index_metadb"> index_metadb </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../models/jsonapi/" title="jsonapi"> jsonapi </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../models/links/" title="links"> links </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../models/optimade_json/" title="optimade_json"> optimade_json </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../models/references/" title="references"> references </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../models/responses/" title="responses"> responses </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../models/structures/" title="structures"> structures </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../models/utils/" title="utils"> utils </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input checked="" class="md-nav__toggle md-toggle" data-md-toggle="nav-8-5" id="nav-8-5" type="checkbox"/> <label class="md-nav__link" for="nav-8-5"> server <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="server" class="md-nav" data-md-level="2"> <label class="md-nav__title" for="nav-8-5"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> server </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../config/" title="config"> config </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../exception_handlers/" title="exception_handlers"> exception_handlers </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../exceptions/" title="exceptions"> exceptions </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../logger/" title="logger"> logger </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../main/" title="main"> main </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../main_index/" title="main_index"> main_index </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/> <label class="md-nav__link md-nav__link--active" for="__toc"> middleware <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"></path></svg> </span> </label> <a class="md-nav__link md-nav__link--active" href="./" title="middleware"> middleware </a> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"> <label class="md-nav__title" for="__toc"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> Table of contents </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="#optimade.server.middleware"> optimade.server.middleware </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#optimade.server.middleware.AddWarnings"> AddWarnings </a> <nav aria-label="AddWarnings" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#optimade.server.middleware.AddWarnings.chunk_it_up"> chunk_it_up() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#optimade.server.middleware.AddWarnings.showwarning"> showwarning() </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#optimade.server.middleware.CheckWronglyVersionedBaseUrls"> CheckWronglyVersionedBaseUrls </a> <nav aria-label="CheckWronglyVersionedBaseUrls" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#optimade.server.middleware.CheckWronglyVersionedBaseUrls.check_url"> check_url() </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#optimade.server.middleware.EnsureQueryParamIntegrity"> EnsureQueryParamIntegrity </a> <nav aria-label="EnsureQueryParamIntegrity" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#optimade.server.middleware.EnsureQueryParamIntegrity.check_url"> check_url() </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#optimade.server.middleware.HandleApiHint"> HandleApiHint </a> <nav aria-label="HandleApiHint" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#optimade.server.middleware.HandleApiHint.handle_api_hint"> handle_api_hint() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#optimade.server.middleware.HandleApiHint.is_versioned_base_url"> is_versioned_base_url() </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../query_params/" title="query_params"> query_params </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../warnings/" title="warnings"> warnings </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-5-10" id="nav-8-5-10" type="checkbox"/> <label class="md-nav__link" for="nav-8-5-10"> entry_collections <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="entry_collections" class="md-nav" data-md-level="3"> <label class="md-nav__title" for="nav-8-5-10"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> entry_collections </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../entry_collections/entry_collections/" title="entry_collections"> entry_collections </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../entry_collections/mongo/" title="mongo"> mongo </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-5-11" id="nav-8-5-11" type="checkbox"/> <label class="md-nav__link" for="nav-8-5-11"> mappers <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="mappers" class="md-nav" data-md-level="3"> <label class="md-nav__title" for="nav-8-5-11"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> mappers </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../mappers/entries/" title="entries"> entries </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../mappers/links/" title="links"> links </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../mappers/references/" title="references"> references </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../mappers/structures/" title="structures"> structures </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-5-12" id="nav-8-5-12" type="checkbox"/> <label class="md-nav__link" for="nav-8-5-12"> routers <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="routers" class="md-nav" data-md-level="3"> <label class="md-nav__title" for="nav-8-5-12"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> routers </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../routers/index_info/" title="index_info"> index_info </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../routers/info/" title="info"> info </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../routers/landing/" title="landing"> landing </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../routers/links/" title="links"> links </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../routers/references/" title="references"> references </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../routers/structures/" title="structures"> structures </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../routers/utils/" title="utils"> utils </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../routers/versions/" title="versions"> versions </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-6" id="nav-8-6" type="checkbox"/> <label class="md-nav__link" for="nav-8-6"> validator <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg> </span> </label> <nav aria-label="validator" class="md-nav" data-md-level="2"> <label class="md-nav__title" for="nav-8-6"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> validator </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../validator/validator/" title="validator"> validator </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../validator/validator_model_patches/" title="validator_model_patches"> validator_model_patches </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component="toc"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"> <label class="md-nav__title" for="__toc"> <span class="md-nav__icon md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </span> Table of contents </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="#optimade.server.middleware"> optimade.server.middleware </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#optimade.server.middleware.AddWarnings"> AddWarnings </a> <nav aria-label="AddWarnings" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#optimade.server.middleware.AddWarnings.chunk_it_up"> chunk_it_up() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#optimade.server.middleware.AddWarnings.showwarning"> showwarning() </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#optimade.server.middleware.CheckWronglyVersionedBaseUrls"> CheckWronglyVersionedBaseUrls </a> <nav aria-label="CheckWronglyVersionedBaseUrls" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#optimade.server.middleware.CheckWronglyVersionedBaseUrls.check_url"> check_url() </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#optimade.server.middleware.EnsureQueryParamIntegrity"> EnsureQueryParamIntegrity </a> <nav aria-label="EnsureQueryParamIntegrity" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#optimade.server.middleware.EnsureQueryParamIntegrity.check_url"> check_url() </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#optimade.server.middleware.HandleApiHint"> HandleApiHint </a> <nav aria-label="HandleApiHint" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#optimade.server.middleware.HandleApiHint.handle_api_hint"> handle_api_hint() </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#optimade.server.middleware.HandleApiHint.is_versioned_base_url"> is_versioned_base_url() </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-content"> <article class="md-content__inner md-typeset"> <h1 id="middleware">middleware<a class="headerlink" href="#middleware" title="Permanent link">¶</a></h1> <div class="doc doc-object doc-module"> <h2 class="hidden-toc" href="#optimade.server.middleware" id="optimade.server.middleware" style="visibility: hidden; width: 0; height: 0;"> <a class="headerlink" href="#optimade.server.middleware" title="Permanent link">¶</a></h2> <div class="doc doc-contents first"> <p>Custom ASGI app middleware.</p> <p>These middleware are based on <a href="https://www.starlette.io">Starlette</a>'s <code>BaseHTTPMiddleware</code>. See the specific Starlette <a href="https://www.starlette.io/middleware/">documentation page</a> for more information on it's middleware implementation.</p> <div class="doc doc-children"> <div class="doc doc-object doc-class"> <h2 class="doc doc-heading" id="optimade.server.middleware.AddWarnings"> <code>AddWarnings</code> <a class="headerlink" href="#optimade.server.middleware.AddWarnings" title="Permanent link">¶</a></h2> <div class="doc doc-contents"> <p>Add <a href="https://www.optimade.org/optimade-python-tools/api_reference/server/warnings/#optimade.server.warnings.OptimadeWarning"><code>OptimadeWarning</code></a>s to the response.</p> <p>All sub-classes of <a href="https://www.optimade.org/optimade-python-tools/api_reference/server/warnings/#optimade.server.warnings.OptimadeWarning"><code>OptimadeWarning</code></a> will also be added to the response's <a href="https://www.optimade.org/optimade-python-tools/api_reference/models/optimade_json/#optimade.models.optimade_json.ResponseMeta.warnings"><code>meta.warnings</code></a> list.</p> <p>By overriding the <code>warnings.showwarning()</code> function with the <a href="https://www.optimade.org/optimade-python-tools/api_reference/server/middleware/#optimade.server.middleware.AddWarnings.showwarning">showwarning method</a>, all usages of <code>warnings.warn()</code> will result in the regular printing of the warning message to <code>stderr</code>, but also its addition to an in-memory list of warnings. This middleware will, after the URL request has been handled, add the list of accumulated warnings to the JSON response under the <a href="https://www.optimade.org/optimade-python-tools/api_reference/models/optimade_json/#optimade.models.optimade_json.ResponseMeta.warnings"><code>meta.warnings</code></a> field.</p> <p>To make sure the last part happens correctly and a Starlette <code>StreamingResponse</code> is returned, as is expected from a <code>BaseHTTPMiddleware</code> sub-class, one is instantiated with the updated <code>Content-Length</code> header, as well as making sure the response's body content is actually streamable, by breaking it down into chunks of the original response's chunk size.</p> <p><strong>Attributes:</strong></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>_warnings</code></td> <td><code>List[Warnings]</code></td> <td> <p>List of <a href="https://www.optimade.org/optimade-python-tools/api_reference/models/optimade_json/#optimade.models.optimade_json.Warnings">Warnings</a> added through usages of <code>warnings.warn()</code> via <a href="https://www.optimade.org/optimade-python-tools/api_reference/server/middleware/#optimade.server.middleware.AddWarnings.showwarning">showwarning</a>.</p> </td> </tr> </tbody> </table> <div class="doc doc-children"> <div class="doc doc-object doc-method"> <h3 class="doc doc-heading" id="optimade.server.middleware.AddWarnings.chunk_it_up"> <code class="highlight language-python"> chunk_it_up<span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">)</span> </code> <span class="doc doc-properties"> <small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small> </span> <a class="headerlink" href="#optimade.server.middleware.AddWarnings.chunk_it_up" title="Permanent link">¶</a></h3> <div class="doc doc-contents"> <p>Return generator for string in chunks of size <code>chunk_size</code>.</p> <p><strong>Parameters:</strong></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr> <td><code>content</code></td> <td><code>str</code></td> <td> <p>String-content to separate into chunks.</p> </td> <td><em>required</em></td> </tr> <tr> <td><code>chunk_size</code></td> <td><code>int</code></td> <td> <p>The size of the chunks, i.e. the length of the string-chunks.</p> </td> <td><em>required</em></td> </tr> </tbody> </table> <p><strong>Returns:</strong></p> <table> <thead> <tr> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>Generator</code></td> <td> <p>A Python generator to be converted later to an <code>asyncio</code> generator.</p> </td> </tr> </tbody> </table> <details class="quote"> <summary>Source code in <code>optimade/server/middleware.py</code></summary> <table class="highlighttable"> <tr> <td class="linenos"> <div class="linenodiv"> <pre><span></span>404
405
406
407
408
409
410
411
412
413
414
415
416
417
418</pre> </div> </td> <td class="code"> <div class="highlight"> <pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">chunk_it_up</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">:</span>
    <span class="sd">"""Return generator for string in chunks of size `chunk_size`.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        content: String-content to separate into chunks.</span>
<span class="sd">        chunk_size: The size of the chunks, i.e. the length of the string-chunks.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A Python generator to be converted later to an `asyncio` generator.</span>

<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">chunk_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">chunk_size</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">))</span>
</code></pre> </div> </td> </tr> </table> </details> </div> </div> <div class="doc doc-object doc-method"> <h3 class="doc doc-heading" id="optimade.server.middleware.AddWarnings.showwarning"> <code class="highlight language-python"> showwarning<span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> </code> <a class="headerlink" href="#optimade.server.middleware.AddWarnings.showwarning" title="Permanent link">¶</a></h3> <div class="doc doc-contents"> <p>Hook to write a warning to a file using the built-in <code>warnings</code> lib.</p> <p>In <a href="https://docs.python.org/3/library/warnings.html">the documentation</a> for the built-in <code>warnings</code> library, there are a few recommended ways of customizing the printing of warning messages.</p> <p>This method can override the <code>warnings.showwarning</code> function, which is called as part of the <code>warnings</code> library's workflow to print warning messages, e.g., when using <code>warnings.warn()</code>. Originally, it prints warning messages to <code>stderr</code>. This method will also print warning messages to <code>stderr</code> by calling <code>warnings._showwarning_orig()</code> or <code>warnings._showwarnmsg_impl()</code>. The first function will be called if the issued warning is not recognized as an <a href="https://www.optimade.org/optimade-python-tools/api_reference/server/warnings/#optimade.server.warnings.OptimadeWarning"><code>OptimadeWarning</code></a>. This is equivalent to "standard behaviour". The second function will be called <em>after</em> an <a href="https://www.optimade.org/optimade-python-tools/api_reference/server/warnings/#optimade.server.warnings.OptimadeWarning"><code>OptimadeWarning</code></a> has been handled.</p> <p>An <a href="https://www.optimade.org/optimade-python-tools/api_reference/server/warnings/#optimade.server.warnings.OptimadeWarning"><code>OptimadeWarning</code></a> will be translated into an OPTIMADE Warnings JSON object in accordance with <a href="https://github.com/Materials-Consortia/OPTIMADE/blob/v1.0.0/optimade.rst#json-response-schema-common-fields">the specification</a>. This process is similar to the <a href="https://www.optimade.org/optimade-python-tools/api_reference/server/exception_handlers/#optimade.server.exception_handlers">Exception handlers</a>.</p> <p><strong>Parameters:</strong></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr> <td><code>message</code></td> <td><code>Warning</code></td> <td> <p>The <code>Warning</code> object to show and possibly handle.</p> </td> <td><em>required</em></td> </tr> <tr> <td><code>category</code></td> <td><code>Type[Warning]</code></td> <td> <p><code>Warning</code> type being warned about. This amounts to <code>type(message)</code>.</p> </td> <td><em>required</em></td> </tr> <tr> <td><code>filename</code></td> <td><code>str</code></td> <td> <p>Name of the file, where the warning was issued.</p> </td> <td><em>required</em></td> </tr> <tr> <td><code>lineno</code></td> <td><code>int</code></td> <td> <p>Line number in the file, where the warning was issued.</p> </td> <td><em>required</em></td> </tr> <tr> <td><code>file</code></td> <td><code>Optional[IO]</code></td> <td> <p>A file-like object to which the warning should be written.</p> </td> <td><code>None</code></td> </tr> <tr> <td><code>line</code></td> <td><code>Optional[str]</code></td> <td> <p>Source content of the line that issued the warning.</p> </td> <td><code>None</code></td> </tr> </tbody> </table> <details class="quote"> <summary>Source code in <code>optimade/server/middleware.py</code></summary> <table class="highlighttable"> <tr> <td class="linenos"> <div class="linenodiv"> <pre><span></span>308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402</pre> </div> </td> <td class="code"> <div class="highlight"> <pre><span></span><code><span class="k">def</span> <span class="nf">showwarning</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">message</span><span class="p">:</span> <span class="ne">Warning</span><span class="p">,</span>
    <span class="n">category</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="ne">Warning</span><span class="p">],</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">lineno</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IO</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">line</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Hook to write a warning to a file using the built-in `warnings` lib.</span>

<span class="sd">    In [the documentation](https://docs.python.org/3/library/warnings.html)</span>
<span class="sd">    for the built-in `warnings` library, there are a few recommended ways of</span>
<span class="sd">    customizing the printing of warning messages.</span>

<span class="sd">    This method can override the `warnings.showwarning` function,</span>
<span class="sd">    which is called as part of the `warnings` library's workflow to print</span>
<span class="sd">    warning messages, e.g., when using `warnings.warn()`.</span>
<span class="sd">    Originally, it prints warning messages to `stderr`.</span>
<span class="sd">    This method will also print warning messages to `stderr` by calling</span>
<span class="sd">    `warnings._showwarning_orig()` or `warnings._showwarnmsg_impl()`.</span>
<span class="sd">    The first function will be called if the issued warning is not recognized</span>
<span class="sd">    as an [`OptimadeWarning`][optimade.server.warnings.OptimadeWarning].</span>
<span class="sd">    This is equivalent to "standard behaviour".</span>
<span class="sd">    The second function will be called _after_ an</span>
<span class="sd">    [`OptimadeWarning`][optimade.server.warnings.OptimadeWarning] has been handled.</span>

<span class="sd">    An [`OptimadeWarning`][optimade.server.warnings.OptimadeWarning] will be</span>
<span class="sd">    translated into an OPTIMADE Warnings JSON object in accordance with</span>
<span class="sd">    [the specification](https://github.com/Materials-Consortia/OPTIMADE/blob/v1.0.0/optimade.rst#json-response-schema-common-fields).</span>
<span class="sd">    This process is similar to the [Exception handlers][optimade.server.exception_handlers].</span>

<span class="sd">    Parameters:</span>
<span class="sd">        message: The `Warning` object to show and possibly handle.</span>
<span class="sd">        category: `Warning` type being warned about. This amounts to `type(message)`.</span>
<span class="sd">        filename: Name of the file, where the warning was issued.</span>
<span class="sd">        lineno: Line number in the file, where the warning was issued.</span>
<span class="sd">        file: A file-like object to which the warning should be written.</span>
<span class="sd">        line: Source content of the line that issued the warning.</span>

<span class="sd">    """</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">message</span><span class="p">,</span> <span class="ne">Warning</span>
    <span class="p">),</span> <span class="s2">"'message' is expected to be a Warning or subclass thereof."</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">OptimadeWarning</span><span class="p">):</span>
        <span class="c1"># If the Warning is not an OptimadeWarning or subclass thereof,</span>
        <span class="c1"># use the regular 'showwarning' function.</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">_showwarning_orig</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Format warning</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">detail</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">detail</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">detail</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># All this is taken directly from the warnings library.</span>
            <span class="c1"># See 'warnings._formatwarnmsg_impl()' for the original code.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">linecache</span>

                <span class="n">line</span> <span class="o">=</span> <span class="n">linecache</span><span class="o">.</span><span class="n">getline</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># When a warning is logged during Python shutdown, linecache</span>
                <span class="c1"># and the import machinery don't work anymore</span>
                <span class="n">line</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">linecache</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"filename"</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
            <span class="s2">"lineno"</span><span class="p">:</span> <span class="n">lineno</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">meta</span><span class="p">[</span><span class="s2">"line"</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
        <span class="n">new_warning</span> <span class="o">=</span> <span class="n">Warnings</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">detail</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_warning</span> <span class="o">=</span> <span class="n">Warnings</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">detail</span><span class="p">)</span>

    <span class="c1"># Add new warning to self._warnings</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_warning</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="c1"># Show warning message as normal in sys.stderr</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">_showwarnmsg_impl</span><span class="p">(</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">WarningMessage</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre> </div> </td> </tr> </table> </details> </div> </div> </div> </div> </div> <div class="doc doc-object doc-class"> <h2 class="doc doc-heading" id="optimade.server.middleware.CheckWronglyVersionedBaseUrls"> <code>CheckWronglyVersionedBaseUrls</code> <a class="headerlink" href="#optimade.server.middleware.CheckWronglyVersionedBaseUrls" title="Permanent link">¶</a></h2> <div class="doc doc-contents"> <p>If a non-supported versioned base URL is supplied return <code>553 Version Not Supported</code>.</p> <div class="doc doc-children"> <div class="doc doc-object doc-method"> <h3 class="doc doc-heading" id="optimade.server.middleware.CheckWronglyVersionedBaseUrls.check_url"> <code class="highlight language-python"> check_url<span class="p">(</span><span class="n">parsed_url</span><span class="p">)</span> </code> <span class="doc doc-properties"> <small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small> </span> <a class="headerlink" href="#optimade.server.middleware.CheckWronglyVersionedBaseUrls.check_url" title="Permanent link">¶</a></h3> <div class="doc doc-contents"> <p>Check URL path for versioned part.</p> <p><strong>Parameters:</strong></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr> <td><code>parsed_url</code></td> <td><code>ParseResult</code></td> <td> <p>A complete urllib-parsed raw URL.</p> </td> <td><em>required</em></td> </tr> </tbody> </table> <p><strong>Exceptions:</strong></p> <table> <thead> <tr> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>VersionNotSupported</code></td> <td> <p>If the URL represents an OPTIMADE versioned base URL and the version part is not supported by the implementation.</p> </td> </tr> </tbody> </table> <details class="quote"> <summary>Source code in <code>optimade/server/middleware.py</code></summary> <table class="highlighttable"> <tr> <td class="linenos"> <div class="linenodiv"> <pre><span></span> 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108</pre> </div> </td> <td class="code"> <div class="highlight"> <pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">check_url</span><span class="p">(</span><span class="n">parsed_url</span><span class="p">:</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">ParseResult</span><span class="p">):</span>
    <span class="sd">"""Check URL path for versioned part.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        parsed_url: A complete urllib-parsed raw URL.</span>

<span class="sd">    Raises:</span>
<span class="sd">        VersionNotSupported: If the URL represents an OPTIMADE versioned base URL</span>
<span class="sd">            and the version part is not supported by the implementation.</span>

<span class="sd">    """</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="n">get_base_url</span><span class="p">(</span><span class="n">parsed_url</span><span class="p">)</span>
    <span class="n">optimade_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">netloc</span><span class="si">}{</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">"</span><span class="p">[</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">base_url</span><span class="p">)</span> <span class="p">:</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">"^/v[0-9]+"</span><span class="p">,</span> <span class="n">optimade_path</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">version_prefix</span> <span class="ow">in</span> <span class="n">BASE_URL_PREFIXES</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">optimade_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">version_prefix</span><span class="si">}</span><span class="s2">/"</span><span class="p">):</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">version_prefix</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">"(/v[0-9]+(\.[0-9]+){0,2})"</span><span class="p">,</span> <span class="n">optimade_path</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">VersionNotSupported</span><span class="p">(</span>
                <span class="n">detail</span><span class="o">=</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"The parsed versioned base URL </span><span class="si">{</span><span class="n">version_prefix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">!r}</span><span class="s2"> from "</span>
                    <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlunparse</span><span class="p">(</span><span class="n">parsed_url</span><span class="p">)</span><span class="si">!r}</span><span class="s2"> is not supported by this implementation. "</span>
                    <span class="sa">f</span><span class="s2">"Supported versioned base URLs are: </span><span class="si">{</span><span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_URL_PREFIXES</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="si">}</span><span class="s2">"</span>
                <span class="p">)</span>
            <span class="p">)</span>
</code></pre> </div> </td> </tr> </table> </details> </div> </div> </div> </div> </div> <div class="doc doc-object doc-class"> <h2 class="doc doc-heading" id="optimade.server.middleware.EnsureQueryParamIntegrity"> <code>EnsureQueryParamIntegrity</code> <a class="headerlink" href="#optimade.server.middleware.EnsureQueryParamIntegrity" title="Permanent link">¶</a></h2> <div class="doc doc-contents"> <p>Ensure all query parameters are followed by an equal sign (<code>=</code>).</p> <div class="doc doc-children"> <div class="doc doc-object doc-method"> <h3 class="doc doc-heading" id="optimade.server.middleware.EnsureQueryParamIntegrity.check_url"> <code class="highlight language-python"> check_url<span class="p">(</span><span class="n">url_query</span><span class="p">)</span> </code> <span class="doc doc-properties"> <small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small> </span> <a class="headerlink" href="#optimade.server.middleware.EnsureQueryParamIntegrity.check_url" title="Permanent link">¶</a></h3> <div class="doc doc-contents"> <p>Check parsed URL query part for parameters not followed by <code>=</code>.</p> <p>URL query parameters are considered to be split by ampersand (<code>&amp;</code>) and semi-colon (<code>;</code>).</p> <p><strong>Parameters:</strong></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr> <td><code>url_query</code></td> <td><code>str</code></td> <td> <p>The raw urllib-parsed query part.</p> </td> <td><em>required</em></td> </tr> </tbody> </table> <p><strong>Exceptions:</strong></p> <table> <thead> <tr> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>BadRequest</code></td> <td> <p>If a query parameter does not come with a value.</p> </td> </tr> </tbody> </table> <p><strong>Returns:</strong></p> <table> <thead> <tr> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>set</code></td> <td> <p>The set of individual query parameters and their values.</p> <p>This is mainly for testing and not actually neeeded by the middleware, since if the URL exhibits an invalid query part a <code>400 Bad Request</code> response will be returned.</p> </td> </tr> </tbody> </table> <details class="quote"> <summary>Source code in <code>optimade/server/middleware.py</code></summary> <table class="highlighttable"> <tr> <td class="linenos"> <div class="linenodiv"> <pre><span></span>37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67</pre> </div> </td> <td class="code"> <div class="highlight"> <pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">check_url</span><span class="p">(</span><span class="n">url_query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
    <span class="sd">"""Check parsed URL query part for parameters not followed by `=`.</span>

<span class="sd">    URL query parameters are considered to be split by ampersand (`&amp;`)</span>
<span class="sd">    and semi-colon (`;`).</span>

<span class="sd">    Parameters:</span>
<span class="sd">        url_query: The raw urllib-parsed query part.</span>

<span class="sd">    Raises:</span>
<span class="sd">        BadRequest: If a query parameter does not come with a value.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The set of individual query parameters and their values.</span>

<span class="sd">        This is mainly for testing and not actually neeeded by the middleware,</span>
<span class="sd">        since if the URL exhibits an invalid query part a `400 Bad Request`</span>
<span class="sd">        response will be returned.</span>

<span class="sd">    """</span>
    <span class="n">queries_amp</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">url_query</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"&amp;"</span><span class="p">))</span>
    <span class="n">queries</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">queries_amp</span><span class="p">:</span>
        <span class="n">queries</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">";"</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">"="</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query</span> <span class="ow">and</span> <span class="n">query</span> <span class="o">!=</span> <span class="s2">""</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span>
                <span class="n">detail</span><span class="o">=</span><span class="s2">"A query parameter without an equal sign (=) is not supported by this server"</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">queries</span>  <span class="c1"># Useful for testing</span>
</code></pre> </div> </td> </tr> </table> </details> </div> </div> </div> </div> </div> <div class="doc doc-object doc-class"> <h2 class="doc doc-heading" id="optimade.server.middleware.HandleApiHint"> <code>HandleApiHint</code> <a class="headerlink" href="#optimade.server.middleware.HandleApiHint" title="Permanent link">¶</a></h2> <div class="doc doc-contents"> <p>Handle <code>api_hint</code> query parameter.</p> <div class="doc doc-children"> <div class="doc doc-object doc-method"> <h3 class="doc doc-heading" id="optimade.server.middleware.HandleApiHint.handle_api_hint"> <code class="highlight language-python"> handle_api_hint<span class="p">(</span><span class="n">api_hint</span><span class="p">)</span> </code> <span class="doc doc-properties"> <small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small> </span> <a class="headerlink" href="#optimade.server.middleware.HandleApiHint.handle_api_hint" title="Permanent link">¶</a></h3> <div class="doc doc-contents"> <p>Handle <code>api_hint</code> parameter value.</p> <p>There are several scenarios that can play out, when handling the <code>api_hint</code> query parameter:</p> <p>If several <code>api_hint</code> query parameters have been used, or a "standard" JSON list (<code>,</code>-separated value) has been supplied, a warning will be added to the response and the <code>api_hint</code> query parameter will not be applied.</p> <p>If the passed value does not comply with the rules set out in <a href="https://github.com/Materials-Consortia/OPTIMADE/blob/v1.0.0/optimade.rst#version-negotiation">the specification</a>, a warning will be added to the response and the <code>api_hint</code> query parameter will not be applied.</p> <p>If the value is part of the implementation's accepted versioned base URLs, it will be returned as is.</p> <p>If the value represents a major version that is newer than what is supported by the implementation, a <code>553 Version Not Supported</code> response will be returned, as is stated by <a href="https://github.com/Materials-Consortia/OPTIMADE/blob/v1.0.0/optimade.rst#version-negotiation">the specification</a>.</p> <p>On the other hand, if the value represents a major version equal to or lower than the implementation's supported major version, then the implementation's supported major version will be returned and tried for the request.</p> <p><strong>Parameters:</strong></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr> <td><code>api_hint</code></td> <td><code>List[str]</code></td> <td> <p>The urllib-parsed query parameter value for <code>api_hint</code>.</p> </td> <td><em>required</em></td> </tr> </tbody> </table> <p><strong>Exceptions:</strong></p> <table> <thead> <tr> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>VersionNotSupported</code></td> <td> <p>If the requested major version is newer than the supported major version of the implementation.</p> </td> </tr> </tbody> </table> <p><strong>Returns:</strong></p> <table> <thead> <tr> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>Union[NoneType, str]</code></td> <td> <p>Either a valid <code>api_hint</code> value or <code>None</code>.</p> </td> </tr> </tbody> </table> <details class="quote"> <summary>Source code in <code>optimade/server/middleware.py</code></summary> <table class="highlighttable"> <tr> <td class="linenos"> <div class="linenodiv"> <pre><span></span>121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203</pre> </div> </td> <td class="code"> <div class="highlight"> <pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">handle_api_hint</span><span class="p">(</span><span class="n">api_hint</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sd">"""Handle `api_hint` parameter value.</span>

<span class="sd">    There are several scenarios that can play out, when handling the `api_hint`</span>
<span class="sd">    query parameter:</span>

<span class="sd">    If several `api_hint` query parameters have been used, or a "standard" JSON</span>
<span class="sd">    list (`,`-separated value) has been supplied, a warning will be added to the</span>
<span class="sd">    response and the `api_hint` query parameter will not be applied.</span>

<span class="sd">    If the passed value does not comply with the rules set out in</span>
<span class="sd">    [the specification](https://github.com/Materials-Consortia/OPTIMADE/blob/v1.0.0/optimade.rst#version-negotiation),</span>
<span class="sd">    a warning will be added to the response and the `api_hint` query parameter</span>
<span class="sd">    will not be applied.</span>

<span class="sd">    If the value is part of the implementation's accepted versioned base URLs,</span>
<span class="sd">    it will be returned as is.</span>

<span class="sd">    If the value represents a major version that is newer than what is supported</span>
<span class="sd">    by the implementation, a `553 Version Not Supported` response will be returned,</span>
<span class="sd">    as is stated by [the specification](https://github.com/Materials-Consortia/OPTIMADE/blob/v1.0.0/optimade.rst#version-negotiation).</span>

<span class="sd">    On the other hand, if the value represents a major version equal to or lower</span>
<span class="sd">    than the implementation's supported major version, then the implementation's</span>
<span class="sd">    supported major version will be returned and tried for the request.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        api_hint: The urllib-parsed query parameter value for `api_hint`.</span>

<span class="sd">    Raises:</span>
<span class="sd">        VersionNotSupported: If the requested major version is newer than the</span>
<span class="sd">            supported major version of the implementation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Either a valid `api_hint` value or `None`.</span>

<span class="sd">    """</span>
    <span class="c1"># Try to split by `,` if value is provided once, but in JSON-type "list" format</span>
    <span class="n">_api_hint</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">api_hint</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">)</span>
        <span class="n">_api_hint</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">api_hint</span> <span class="o">=</span> <span class="n">_api_hint</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">api_hint</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="n">TooManyValues</span><span class="p">(</span>
                <span class="n">detail</span><span class="o">=</span><span class="s2">"`api_hint` should only be supplied once, with a single value."</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">api_hint</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"/</span><span class="si">{</span><span class="n">api_hint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">"^/v[0-9]+(\.[0-9]+)?$"</span><span class="p">,</span> <span class="n">api_hint</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="n">FieldValueNotRecognized</span><span class="p">(</span>
                <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">api_hint</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="si">!r}</span><span class="s2"> is not recognized as a valid `api_hint` value."</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">api_hint</span> <span class="ow">in</span> <span class="n">BASE_URL_PREFIXES</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">api_hint</span>

    <span class="n">major_api_hint</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">"/v([0-9]+)"</span><span class="p">,</span> <span class="n">api_hint</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">major_implementation</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">BASE_URL_PREFIXES</span><span class="p">[</span><span class="s2">"major"</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="s2">"/v"</span><span class="p">)</span> <span class="p">:])</span>

    <span class="k">if</span> <span class="n">major_api_hint</span> <span class="o">&gt;</span> <span class="n">major_implementation</span><span class="p">:</span>
        <span class="c1"># Let's not try to handle a request for a newer major version</span>
        <span class="k">raise</span> <span class="n">VersionNotSupported</span><span class="p">(</span>
            <span class="n">detail</span><span class="o">=</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"The provided `api_hint` (</span><span class="si">{</span><span class="n">api_hint</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="si">!r}</span><span class="s2">) is not supported by this implementation. "</span>
                <span class="sa">f</span><span class="s2">"Supported versions include: </span><span class="si">{</span><span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_URL_PREFIXES</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="si">}</span><span class="s2">"</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">major_api_hint</span> <span class="o">&lt;=</span> <span class="n">major_implementation</span><span class="p">:</span>
        <span class="c1"># If less than:</span>
        <span class="c1"># Use the current implementation in hope that it can still handle older requests</span>
        <span class="c1">#</span>
        <span class="c1"># If equal:</span>
        <span class="c1"># Go to /v&lt;MAJOR&gt;, since this should point to the latest available</span>
        <span class="k">return</span> <span class="n">BASE_URL_PREFIXES</span><span class="p">[</span><span class="s2">"major"</span><span class="p">]</span>
</code></pre> </div> </td> </tr> </table> </details> </div> </div> <div class="doc doc-object doc-method"> <h3 class="doc doc-heading" id="optimade.server.middleware.HandleApiHint.is_versioned_base_url"> <code class="highlight language-python"> is_versioned_base_url<span class="p">(</span><span class="n">url</span><span class="p">)</span> </code> <span class="doc doc-properties"> <small class="doc doc-property doc-property-staticmethod"><code>staticmethod</code></small> </span> <a class="headerlink" href="#optimade.server.middleware.HandleApiHint.is_versioned_base_url" title="Permanent link">¶</a></h3> <div class="doc doc-contents"> <p>Determine whether a request is for a versioned base URL.</p> <p>First, simply check whether a <code>/vMAJOR(.MINOR.PATCH)</code> part exists in the URL. If not, return <code>False</code>, else, remove unversioned base URL from the URL and check again. Return <code>bool</code> of final result.</p> <p><strong>Parameters:</strong></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr> <td><code>url</code></td> <td><code>str</code></td> <td> <p>The full URL to check.</p> </td> <td><em>required</em></td> </tr> </tbody> </table> <p><strong>Returns:</strong></p> <table> <thead> <tr> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>bool</code></td> <td> <p>Whether or not the full URL represents an OPTIMADE versioned base URL.</p> </td> </tr> </tbody> </table> <details class="quote"> <summary>Source code in <code>optimade/server/middleware.py</code></summary> <table class="highlighttable"> <tr> <td class="linenos"> <div class="linenodiv"> <pre><span></span>205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224</pre> </div> </td> <td class="code"> <div class="highlight"> <pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">is_versioned_base_url</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">"""Determine whether a request is for a versioned base URL.</span>

<span class="sd">    First, simply check whether a `/vMAJOR(.MINOR.PATCH)` part exists in the URL.</span>
<span class="sd">    If not, return `False`, else, remove unversioned base URL from the URL and check again.</span>
<span class="sd">    Return `bool` of final result.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        url: The full URL to check.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Whether or not the full URL represents an OPTIMADE versioned base URL.</span>

<span class="sd">    """</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">"(/v[0-9]+(\.[0-9]+){0,2})"</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">base_url</span> <span class="o">=</span> <span class="n">get_base_url</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">"(/v[0-9]+(\.[0-9]+){0,2})"</span><span class="p">,</span> <span class="n">url</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">base_url</span><span class="p">)</span> <span class="p">:]))</span>
</code></pre> </div> </td> </tr> </table> </details> </div> </div> </div> </div> </div> </div> </div> </div> </article> </div> </div> </main> <footer class="md-footer"> <div class="md-footer-nav"> <nav aria-label="Footer" class="md-footer-nav__inner md-grid"> <a class="md-footer-nav__link md-footer-nav__link--prev" href="../main_index/" rel="prev" title="main_index"> <div class="md-footer-nav__button md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </div> <div class="md-footer-nav__title"> <div class="md-ellipsis"> <span class="md-footer-nav__direction"> Previous </span> main_index </div> </div> </a> <a class="md-footer-nav__link md-footer-nav__link--next" href="../query_params/" rel="next" title="query_params"> <div class="md-footer-nav__title"> <div class="md-ellipsis"> <span class="md-footer-nav__direction"> Next </span> query_params </div> </div> <div class="md-footer-nav__button md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"></path></svg> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class="md-footer-copyright"> <div class="md-footer-copyright__highlight"> Built by the Materials-Consortia </div> Made with <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank"> Material for MkDocs </a> </div> <div class="md-footer-social"> <a class="md-footer-social__link" href="https://github.com/Materials-Consortia" rel="noopener" target="_blank" title="github.com"> <svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg> </a> </div> </div> </div> </footer> </div> <script src="../../../assets/javascripts/vendor.c3dc8c49.min.js"></script> <script src="../../../assets/javascripts/bundle.f9edbbd5.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script> <script>
        app = initialize({
          base: "../../..",
          features: [],
          search: Object.assign({
            worker: "../../../assets/javascripts/worker/search.8e2cddea.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script> </body> </html>